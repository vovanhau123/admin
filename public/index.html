<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Script Manager</title>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/flatpickr.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/flatpickr.min.js"></script>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            max-width: 900px;
            width: 100%;
        }

        h1, h2 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        #scriptButtons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .script-card {
            background-color: #ffffff;
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .script-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .script-card button {
            margin: 5px;
            padding: 10px 20px;
            font-size: 14px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            font-weight: bold;
        }

        .script-card button:hover {
            filter: brightness(110%);
        }

        .script-card button.start { background-color: #4CAF50; color: white; }
        .script-card button.restart { background-color: #2196F3; color: white; }
        .script-card button.stop { background-color: #f44336; color: white; }
        .script-card button.schedule { background-color: #9c27b0; color: white; }

        .status {
            font-weight: bold;
            margin-top: 10px;
            color: #333;
        }

        #logsContainer {
            background-color: #f8f8f8;
            border-radius: 8px;
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            word-wrap: break-word;
            border: 1px solid #ddd;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border-left-color: #ffffff;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        button .spinner { display: none; }
        button.loading .spinner { display: inline-block; }
        button.loading span { display: none; }

        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 300px;
            border-radius: 10px;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Script Manager</h1>
        <div id="scriptButtons"></div>
        <h2>PM2 Logs</h2>
        <div id="logsContainer"></div>
    </div>

    <div id="scheduleModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Schedule Action</h2>
            <input type="text" id="datetimePicker" placeholder="Select date and time">
            <button id="scheduleButton">Schedule</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script>
        const scripts = ['discord', 'index', 'role', 'music-bot'];
        const scriptButtons = document.getElementById('scriptButtons');
        const logsContainer = document.getElementById('logsContainer');
        const modal = document.getElementById('scheduleModal');
        const closeBtn = document.getElementsByClassName('close')[0];
        const datetimePicker = document.getElementById('datetimePicker');
        const scheduleButton = document.getElementById('scheduleButton');
        let currentScriptName = '';
        let currentAction = '';

        flatpickr(datetimePicker, {
            enableTime: true,
            dateFormat: "Y-m-d H:i",
            minDate: "today",
            time_24hr: true,
            defaultHour: new Date().getHours(),
            defaultMinute: new Date().getMinutes()
        });

        const socket = new WebSocket(`${window.location.protocol === 'https:' ? 'wss:' : 'ws:'}//${window.location.host}`);

        socket.onopen = function() {
            console.log('WebSocket connection established');
        };

        socket.onmessage = function(event) {
            const data = JSON.parse(event.data);
            if (data.type === 'scriptStatus') {
                updateButtons(data.data);
            } else if (data.type === 'logs') {
                updateLogs(data.data);
            }
        };

        socket.onerror = function(error) {
            console.error('WebSocket error:', error);
            showToast('Error connecting to server. Please check your connection and try again.', true);
        };

        socket.onclose = function(event) {
            console.log('WebSocket connection closed:', event);
            showToast('Connection to server lost. Attempting to reconnect...', true);
            setTimeout(() => {
                location.reload();
            }, 5000);
        };

        function createButton(script, isRunning) {
            const card = document.createElement('div');
            card.className = 'script-card';
            card.dataset.script = script;

            const startButton = document.createElement('button');
            startButton.className = 'start';
            startButton.innerHTML = `
                <div class="spinner"></div>
                <span>${isRunning ? 'Running' : 'Start'}</span>
            `;
            startButton.onclick = isRunning ? null : () => startScript(script, startButton);
            startButton.classList.toggle('running', isRunning);

            const restartButton = document.createElement('button');
            restartButton.className = 'restart';
            restartButton.textContent = 'Restart';
            restartButton.onclick = () => restartScript(script);

            const stopButton = document.createElement('button');
            stopButton.className = 'stop';
            stopButton.textContent = 'Stop';
            stopButton.onclick = () => stopScript(script);

            const scheduleRestartButton = document.createElement('button');
            scheduleRestartButton.className = 'schedule';
            scheduleRestartButton.textContent = 'Schedule Restart';
            scheduleRestartButton.onclick = () => openScheduleModal(script, 'restart');

            const scheduleStopButton = document.createElement('button');
            scheduleStopButton.className = 'schedule';
            scheduleStopButton.textContent = 'Schedule Stop';
            scheduleStopButton.onclick = () => openScheduleModal(script, 'stop');

            const status = document.createElement('div');
            status.className = 'status';
            status.textContent = script;

            card.appendChild(startButton);
            card.appendChild(restartButton);
            card.appendChild(stopButton);
            card.appendChild(scheduleRestartButton);
            card.appendChild(scheduleStopButton);
            card.appendChild(status);
            return card;
        }

        function updateButtons(statuses) {
            scriptButtons.innerHTML = '';
            scripts.forEach(script => {
                const button = createButton(script, statuses[script]);
                scriptButtons.appendChild(button);
            });
        }

        function updateLogs(logs) {
            logsContainer.textContent += logs;
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        function showToast(message, isError = false) {
            Toastify({
                text: message,
                duration: 3000,
                close: true,
                gravity: "top",
                position: "right",
                backgroundColor: isError ? "#ff6b6b" : "#51cf66",
                className: "info",
                style: {
                    background: "linear-gradient(to right, #00b09b, #96c93d)",
                }
            }).showToast();
        }

        function updateButton(scriptName, isRunning) {
            const card = document.querySelector(`.script-card[data-script="${scriptName}"]`);
            if (card) {
                const startButton = card.querySelector('.start');
                if (startButton) {
                    const span = startButton.querySelector('span');
                    if (span) {
                        span.textContent = isRunning ? 'Running' : 'Start';
                    }
                    startButton.classList.toggle('running', isRunning);
                    startButton.onclick = isRunning ? null : () => startScript(scriptName, startButton);
                }
            }
        }

        function checkScriptStatus(scriptName) {
            fetch(`/api/scripts/status/${scriptName}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    updateButton(scriptName, data[scriptName]);
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast(`Failed to check status for ${scriptName}`, true);
                });
        }

        function performAction(scriptName, action) {
            return fetch(`/api/scripts/${action}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ scriptName }),
            })
            .then(response => response.json())
            .then(data => {
                showToast(data.message);
                return checkScriptStatus(scriptName);
            })
            .catch(error => {
                showToast(`Failed to ${action} script`, true);
                console.error('Error:', error);
            });
        }

        function startScript(scriptName, button) {
            button.classList.add('loading');
            updateButton(scriptName, true);
            performAction(scriptName, 'start')
                .then(() => {
                    button.classList.remove('loading');
                })
                .catch(() => {
                    updateButton(scriptName, false);
                    button.classList.remove('loading');
                });
        }

        function restartScript(scriptName) {
            updateButton(scriptName, false);
            performAction(scriptName, 'restart');
        }

        function stopScript(scriptName) {
            updateButton(scriptName, false);
            performAction(scriptName, 'stop');
        }

        function openScheduleModal(scriptName, action) {
            currentScriptName = scriptName;
            currentAction = action;
            modal.style.display = "block";
        }

        closeBtn.onclick = function() {
            modal.style.display = "none";
        }

        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        scheduleButton.onclick = function() {
            const selectedDateTime = datetimePicker.value;
            if (selectedDateTime) {
                scheduleAction(currentScriptName, currentAction, selectedDateTime);
                modal.style.display = "none";
            } else {
                showToast("Please select a date and time", true);
            }
        }

        function scheduleAction(scriptName, action, time) {
            const localTime = new Date(time);
            const isoTime = localTime.toISOString();
            fetch('/api/schedules', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ scriptName, action, time: isoTime }),
            })
            .then(response => response.json())
            .then(data => showToast(data.message))
            .catch(error => showToast(`Failed to schedule ${action}`, true));
        }

        function checkConnection() {
            if (socket.readyState !== WebSocket.OPEN) {
                showToast('Reconnecting to server...', true);
                socket = new WebSocket(`${window.location.protocol === 'https:' ? 'wss:' : 'ws:'}//${window.location.host}`);
            }
        }

        setInterval(checkConnection, 30000);

        // Thêm hàm mới để lấy lịch sử restart
        function getRestartHistory() {
            fetch('/api/schedules/history')
            .then(response => response.json())
            .then(data => {
                // Xử lý và hiển thị dữ liệu lịch sử restart
                console.log(data);
                // Ví dụ: hiển thị trong một bảng hoặc danh sách
            })
            .catch(error => console.error('Error fetching restart history:', error));
        }

        // Thêm hàm mới để lấy danh sách các hành động đã lên lịch
        function getScheduledActions() {
            fetch('/api/schedules')
            .then(response => response.json())
            .then(data => {
                // Xử lý và hiển thị danh sách các hành động đã lên lịch
                console.log(data);
                // Ví dụ: hiển thị trong một bảng hoặc danh sách
            })
            .catch(error => console.error('Error fetching scheduled actions:', error));
        }
    </script>
</body>

</html>